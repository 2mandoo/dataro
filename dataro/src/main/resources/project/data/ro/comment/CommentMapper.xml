<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="project.data.ro.comment.CommentMapper">
	
	<!-- 댓글 입력 -->
	<insert id="insert" parameterType="project.data.ro.comment.CommentVO">
		INSERT INTO preply (
			content, member_no, board_no, reply_writedate ,reply_no, board_name,gno,member_id )
			 VALUES 
			( #{content}, #{member_no}, #{board_no},NOW(),#{reply_no},'자유게시판',#{gno},#{member_id} )
		<selectKey keyProperty="board_no" resultType="int" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- 댓글, 답글 총 갯수 -->
	<select id="count" parameterType="project.data.ro.comment.CommentVO" resultType="java.lang.Integer">
		SELECT COUNT(*) FROM preply
		WHERE board_no = #{board_no} AND board_name = '자유게시판'
	</select>
	
	<!-- 댓글 불러오기 -->
	<select id="list" parameterType="project.data.ro.comment.CommentVO" resultType="project.data.ro.comment.CommentVO">
		SELECT
		 *
		 , (select id from pmember where member_no = preply.member_no) as id
		FROM preply
		WHERE board_no = #{board_no} AND board_name = '자유게시판' and ono = 0
		ORDER BY reply_writedate DESC
		LIMIT  ${startIdx},${pageRow}
	</select>
	
	<!-- 댓글 삭제 -->
	<delete id="delete" parameterType="int">
		DELETE FROM preply WHERE reply_no= #{reply_no}
	</delete>
	
	<!-- 댓글 수정 -->
	<update id="modify" parameterType="project.data.ro.comment.CommentVO">
		UPDATE preply SET 
		content = #{content}
		, reply_updatedate = now()
		WHERE reply_no = #{reply_no}
	</update>
	
	
	
	<!-- 여기서부턴 답글 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->
	
	<!-- 답글 목록 가져오기 -->
	<select id="commentList" parameterType="project.data.ro.comment.CommentVO" resultType="project.data.ro.comment.CommentVO">
		SELECT *
		FROM preply
		WHERE board_name = #{board_name} AND board_no = #{board_no} AND gno = #{gno} AND ono > 0
		ORDER BY gno DESC, reply_writedate DESC
		LIMIT ${startIdx}, ${pageRow}
	</select>
	
	<!-- gno를 reply_no로 업데이트 -->
	<update id="gnoUpdate" parameterType="int">
		UPDATE preply SET gno = #{gno} WHERE reply_no = #{gno}
	</update>
	
	<!-- 답글 달 때, 부모의 gno와 같고, 부모의 ono보다 큰 ono를 ono+1로 업뎃 -->
	<update id="onoUpdate" parameterType="project.data.ro.comment.CommentVO">
		UPDATE preply SET ono = ono+1 WHERE gno = #{gno} AND ono > #{ono}	
	</update>
	
	<!-- 댓글에 답글달기 -->
	<insert id="reply" parameterType="project.data.ro.comment.CommentVO">
		INSERT INTO preply (
			board_name, board_no, room_no, member_id, content, member_no, reply_likecount, reply_writedate, gno, ono
		) VALUES (
			#{board_name}, #{board_no}, #{room_no}, #{member_id}, #{content}, #{member_no}, 0, NOW(), #{gno}, #{ono}
		)
	</insert>
	
	<!-- 댓글 ono = 0 총 개수 (답글이 아닌 원댓글)-->
	<select id="pagingCount" resultType="int" parameterType="project.data.ro.comment.CommentVO">
		SELECT COUNT(*) FROM preply WHERE board_name = '자유게시판'
		AND board_no = #{board_no} AND ono = 0
	</select>
	
	
</mapper>